---
- name: Check background job mode
  ansible.builtin.command:
    cmd: >-
      podman exec -u www-data nextcloud php occ
      config:app:get core backgroundjobs_mode
  become: true
  become_user: "{{ service_nextcloud_user }}"
  environment:
    XDG_RUNTIME_DIR: "/run/user/{{ service_nextcloud_uid }}"
  register: service_nextcloud_bg_mode
  changed_when: false
  failed_when: false

- name: Set background job mode to cron
  ansible.builtin.command:
    cmd: podman exec -u www-data nextcloud php occ background:cron
  become: true
  become_user: "{{ service_nextcloud_user }}"
  environment:
    XDG_RUNTIME_DIR: "/run/user/{{ service_nextcloud_uid }}"
  when: service_nextcloud_bg_mode.stdout | default('') | trim != 'cron'
  changed_when: true

- name: Check Redis host config
  ansible.builtin.command:
    cmd: >-
      podman exec -u www-data nextcloud php occ
      config:system:get redis host
  become: true
  become_user: "{{ service_nextcloud_user }}"
  environment:
    XDG_RUNTIME_DIR: "/run/user/{{ service_nextcloud_uid }}"
  register: service_nextcloud_redis_host_check
  changed_when: false
  failed_when: false

- name: Set Redis host
  ansible.builtin.command:
    cmd: >-
      podman exec -u www-data nextcloud php occ
      config:system:set redis host --value=nextcloud-redis
  become: true
  become_user: "{{ service_nextcloud_user }}"
  environment:
    XDG_RUNTIME_DIR: "/run/user/{{ service_nextcloud_uid }}"
  when: service_nextcloud_redis_host_check.stdout | default('') | trim != 'nextcloud-redis'
  changed_when: true

- name: Check Redis port config
  ansible.builtin.command:
    cmd: >-
      podman exec -u www-data nextcloud php occ
      config:system:get redis port
  become: true
  become_user: "{{ service_nextcloud_user }}"
  environment:
    XDG_RUNTIME_DIR: "/run/user/{{ service_nextcloud_uid }}"
  register: service_nextcloud_redis_port_check
  changed_when: false
  failed_when: false

- name: Set Redis port
  ansible.builtin.command:
    cmd: >-
      podman exec -u www-data nextcloud php occ
      config:system:set redis port --value=6379 --type=integer
  become: true
  become_user: "{{ service_nextcloud_user }}"
  environment:
    XDG_RUNTIME_DIR: "/run/user/{{ service_nextcloud_uid }}"
  when: service_nextcloud_redis_port_check.stdout | default('') | trim != '6379'
  changed_when: true

- name: Check memcache.local config
  ansible.builtin.command:
    cmd: >-
      podman exec -u www-data nextcloud php occ
      config:system:get memcache.local
  become: true
  become_user: "{{ service_nextcloud_user }}"
  environment:
    XDG_RUNTIME_DIR: "/run/user/{{ service_nextcloud_uid }}"
  register: service_nextcloud_memcache_local_check
  changed_when: false
  failed_when: false

- name: Set memcache.local to APCu
  ansible.builtin.command:
    argv:
      - podman
      - exec
      - -u
      - www-data
      - nextcloud
      - php
      - occ
      - config:system:set
      - memcache.local
      - --value=\OC\Memcache\APCu
  become: true
  become_user: "{{ service_nextcloud_user }}"
  environment:
    XDG_RUNTIME_DIR: "/run/user/{{ service_nextcloud_uid }}"
  when: service_nextcloud_memcache_local_check.stdout | default('') | trim != '\OC\Memcache\APCu'
  changed_when: true

- name: Check memcache.distributed config
  ansible.builtin.command:
    cmd: >-
      podman exec -u www-data nextcloud php occ
      config:system:get memcache.distributed
  become: true
  become_user: "{{ service_nextcloud_user }}"
  environment:
    XDG_RUNTIME_DIR: "/run/user/{{ service_nextcloud_uid }}"
  register: service_nextcloud_memcache_distributed_check
  changed_when: false
  failed_when: false

- name: Set memcache.distributed to Redis
  ansible.builtin.command:
    argv:
      - podman
      - exec
      - -u
      - www-data
      - nextcloud
      - php
      - occ
      - config:system:set
      - memcache.distributed
      - --value=\OC\Memcache\Redis
  become: true
  become_user: "{{ service_nextcloud_user }}"
  environment:
    XDG_RUNTIME_DIR: "/run/user/{{ service_nextcloud_uid }}"
  when: service_nextcloud_memcache_distributed_check.stdout | default('') | trim != '\OC\Memcache\Redis'
  changed_when: true

- name: Check memcache.locking config
  ansible.builtin.command:
    cmd: >-
      podman exec -u www-data nextcloud php occ
      config:system:get memcache.locking
  become: true
  become_user: "{{ service_nextcloud_user }}"
  environment:
    XDG_RUNTIME_DIR: "/run/user/{{ service_nextcloud_uid }}"
  register: service_nextcloud_memcache_locking_check
  changed_when: false
  failed_when: false

- name: Set memcache.locking to Redis
  ansible.builtin.command:
    argv:
      - podman
      - exec
      - -u
      - www-data
      - nextcloud
      - php
      - occ
      - config:system:set
      - memcache.locking
      - --value=\OC\Memcache\Redis
  become: true
  become_user: "{{ service_nextcloud_user }}"
  environment:
    XDG_RUNTIME_DIR: "/run/user/{{ service_nextcloud_uid }}"
  when: service_nextcloud_memcache_locking_check.stdout | default('') | trim != '\OC\Memcache\Redis'
  changed_when: true

- name: Add missing database indices
  ansible.builtin.command:
    cmd: podman exec -u www-data nextcloud php occ db:add-missing-indices
  become: true
  become_user: "{{ service_nextcloud_user }}"
  environment:
    XDG_RUNTIME_DIR: "/run/user/{{ service_nextcloud_uid }}"
  register: service_nextcloud_db_indices
  changed_when: "'Adding' in service_nextcloud_db_indices.stdout"
  when: not ansible_check_mode

- name: Run MIME type migration repair
  ansible.builtin.command:
    cmd: >-
      podman exec -u www-data nextcloud php occ
      maintenance:repair --include-expensive
  become: true
  become_user: "{{ service_nextcloud_user }}"
  environment:
    XDG_RUNTIME_DIR: "/run/user/{{ service_nextcloud_uid }}"
  register: service_nextcloud_mime_repair
  changed_when: "'Repairing' in service_nextcloud_mime_repair.stdout"
  when: not ansible_check_mode

- name: Check if app_api is enabled
  ansible.builtin.command:
    cmd: podman exec -u www-data nextcloud php occ app:list --output=json
  become: true
  become_user: "{{ service_nextcloud_user }}"
  environment:
    XDG_RUNTIME_DIR: "/run/user/{{ service_nextcloud_uid }}"
  register: service_nextcloud_app_list_check
  changed_when: false

- name: Disable app_api
  ansible.builtin.command:
    cmd: podman exec -u www-data nextcloud php occ app:disable app_api
  become: true
  become_user: "{{ service_nextcloud_user }}"
  environment:
    XDG_RUNTIME_DIR: "/run/user/{{ service_nextcloud_uid }}"
  when: >-
    not ansible_check_mode
    and 'app_api' in (service_nextcloud_app_list_check.stdout | from_json).enabled
  changed_when: true

- name: Check OIDC allow_multiple_user_backends setting
  ansible.builtin.command:
    cmd: >-
      podman exec -u www-data nextcloud php occ
      config:app:get user_oidc allow_multiple_user_backends
  become: true
  become_user: "{{ service_nextcloud_user }}"
  environment:
    XDG_RUNTIME_DIR: "/run/user/{{ service_nextcloud_uid }}"
  register: service_nextcloud_oidc_multibackend_check
  changed_when: false
  failed_when: false

- name: Enforce OIDC-only login
  ansible.builtin.command:
    cmd: >-
      podman exec -u www-data nextcloud php occ
      config:app:set user_oidc allow_multiple_user_backends --value=0
  become: true
  become_user: "{{ service_nextcloud_user }}"
  environment:
    XDG_RUNTIME_DIR: "/run/user/{{ service_nextcloud_uid }}"
  when: service_nextcloud_oidc_multibackend_check.stdout | default('') | trim != '0'
  changed_when: true
